<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Borang Undian Wira</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                              url('https://i.postimg.cc/pr2Qq6Dq/Untitled-design.png');
            background-size: cover; background-position: center; color: white;
            font-family: sans-serif; text-align: center; min-height: 100vh;
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        h1 { margin: 2px; text-transform: uppercase; text-shadow: 2px 2px 4px #000; }

        .menu-container { margin-bottom: 20px; }
        .btn {
            background-color: #3b82f6; color: white; border: 2px solid #ffffff;
            padding: 10px 18px; margin: 0 5px; cursor: pointer; font-weight: bold;
            border-radius: 5px;
        }

        .borang-container {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 25px;
            border-radius: 15px;
            width: 350px; 
            min-height: 520px; 
            text-align: left;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .borang-container h3 { text-align: center; text-transform: uppercase; margin-bottom: 20px; font-size: 16px; }

        .input-group { margin-bottom: 12px; display: flex; align-items: center; }
        .input-group label { width: 110px; font-size: 13px; font-weight: bold; }
        .input-group input { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; background-color: #f0f7ff; }

        #preview-container {
            text-align: center;
            margin: 10px auto;
            width: 130px; 
            height: 180px; 
            border: 1px solid #5dade2;
            border-radius: 5px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #gambarWira {
            width: 100%; 
            height: 100%;
            object-fit: cover;
            display: none; 
        }

        #namaPreview {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            color: #1e3a8a;
            margin-top: 5px;
            text-transform: uppercase;
            min-height: 20px;
        }

        .btn-group { 
            margin-top: auto; 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding-top: 20px; 
        }

        .btn-form { 
            padding: 8px 15px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 5px; 
            border: none; 
            font-size: 12px; 
            text-decoration: none; 
            text-align: center; 
        }

        .btn-tambah { 
            background-color: #3b82f6; 
            color: white; 
            width: auto; 
            min-width: 100px;
        }

        .btn-kembali { 
            background-color: #bdc3c7; 
            color: #333; 
            width: auto;
            min-width: 80px;
        }
    </style>
</head>
<body>

    <h1>PENGUNDIAN SEMULA WIRA</h1>
    
    <div class="menu-container">
        <button class="btn" onclick="location.href='try2.html'">IMPORT</button>
        <button class="btn" onclick="location.href='keputusankad.html'">WIRA</button> 
        <button class="btn" onclick="location.href='Keputusan.html'">KEPUTUSAN</button>
    </div>

    <div class="borang-container">
        <h3>Borang Undian Pemain</h3>
        
        <div class="input-group">
            <label>Nama Anda :</label>
            <input type="text" id="namaPengundi" placeholder="Nama anda...">
        </div>

        <div class="input-group">
            <label>ID Wira :</label>
            <input type="text" id="inputID" oninput="cariWira()" placeholder="C1, C2...">
        </div>

        <div id="preview-container">
            <img id="gambarWira" src="">
        </div>
        
        <p id="namaPreview"></p>

        <div class="input-group">
            <label>Nama Wira :</label>
            <input type="text" id="inputNama" readonly>
        </div>
        <div class="input-group">
            <label>Gambar :</label>
            <input type="text" id="inputLink" readonly>
        </div>

        <div class="btn-group">
            <a href="#" class="btn-form btn-kembali" onclick="history.back()">KEMBALI</a>
            <button class="btn-form btn-tambah" onclick="simpanKeFirebase()">UNDI ></button>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://undianwira-default-rtdb.asia-southeast1.firebasedatabase.app/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const dataWira = {
        "C1": { nama: "BALMOND", gambar: "https://i.ibb.co/v6bWTvkx/balmond.webp" },
        "C2": { nama: "LAYLA", gambar: "https://i.ibb.co/rKQXsBqv/layla.webp" },
        "C3": { nama: "TIGREAL", gambar: "https://i.ibb.co/YBYmsV8Y/tigreal.webp" },
        "C4": { nama: "CHANG'E", gambar: "https://i.ibb.co/yc1xKKtb/change.webp" }
    };

    function cariWira() {
        const id = document.getElementById('inputID').value.toUpperCase();
        const img = document.getElementById('gambarWira');
        const txt = document.getElementById('namaPreview');
        const inputNama = document.getElementById('inputNama');
        const inputLink = document.getElementById('inputLink');
        
        if (dataWira[id]) {
            img.src = dataWira[id].gambar;
            img.style.display = "block";
            txt.innerText = dataWira[id].nama;
            inputNama.value = dataWira[id].nama;
            inputLink.value = dataWira[id].gambar;
        } else {
            img.style.display = "none";
            img.src = "";
            txt.innerText = "";
            inputNama.value = "";
            inputLink.value = "";
        }
    }

    function simpanKeFirebase() {
        // Ambil nama dan tukar kepada Huruf Besar untuk mengelakkan penipuan (Contoh: ali & Ali)
        const pengundi = document.getElementById('namaPengundi').value.trim().toUpperCase();
        const wira = document.getElementById('inputNama').value;
        const img = document.getElementById('inputLink').value;

        if (!pengundi || !wira) {
            alert("Sila isi nama anda dan masukkan ID wira yang betul!"); 
            return;
        }

        // --- MULA LOGIK SEKATAN SATU UNDI ---
        database.ref('undian/').orderByChild('pengundi').equalTo(pengundi).once('value', (snapshot) => {
            if (snapshot.exists()) {
                alert("MAAF! Nama '" + pengundi + "' sudah mengundi sebelum ini. Setiap pemain hanya boleh mengundi SEKALI.");
            } else {
                // Jika nama belum wujud, barulah simpan data
                database.ref('undian/').push({
                    pengundi: pengundi,
                    namaWira: wira,
                    gambar: img,
                    waktu: new Date().toLocaleString()
                }).then(() => {
                    alert("Berjaya Mengundi!");
                    location.href = 'Keputusan.html';
                }).catch((error) => {
                    alert("Gagal: " + error.message);
                });
            }
        });
        // --- TAMAT LOGIK SEKATAN ---
    }
</script>
</body>
</html>